<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>活動報名系統</title>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Custom CSS -->
  <style>
    :root {
  --primary-color: #00B900;
  --secondary-color: #1E1E1E;
}

/* Loading 指示器 */
.loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

/* 活動卡片 */
.activity-card {
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.activity-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* LINE 風格按鈕 */
.btn-line {
  background-color: var(--primary-color);
  color: white;
  border: none;
}

.btn-line:hover {
  background-color: #009900;
  color: white;
}

.btn-line:disabled {
  background-color: #cccccc;
  cursor: not-allowed;
}

/* 導航欄品牌 */
.navbar-brand {
  color: var(--primary-color) !important;
  font-weight: bold;
}

/* 使用者資訊 */
#user-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#user-info img {
  width: 30px;
  height: 30px;
  border-radius: 50%;
}

/* 活動狀態標籤 */
.status-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.875rem;
}

.status-badge.registering {
  background-color: var(--primary-color);
  color: white;
}

.status-badge.full {
  background-color: #dc3545;
  color: white;
}

.status-badge.closed {
  background-color: #6c757d;
  color: white;
}

.status-badge.ended {
  background-color: #212529;
  color: white;
}
</style>
</head>
<body>
  <!-- Loading 指示器 -->
  <div id="loading" class="loading" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
  </div>

  <!-- 導航欄 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="#">活動報名系統</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showActivities()">活動列表</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showMyRegistrations()">我的報名</a>
          </li>
          <li class="nav-item admin-section" style="display: none;">
            <a class="nav-link" href="#" onclick="showAdminPanel()">管理面板</a>
          </li>
        </ul>
        <div class="navbar-text" id="user-info">
          載入中...
        </div>
      </div>
    </div>
  </nav>

  <!-- 主要內容區域 -->
  <div class="container mt-4">
    <div id="main-content">
      <!-- 內容將由 JavaScript 動態載入 -->
    </div>
  </div>

  <!-- 報名表單 Modal -->
  <div class="modal fade" id="registrationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">活動報名</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="registration-form">
            <input type="hidden" id="reg-activity-id">
            <div class="mb-3">
              <label class="form-label">姓名</label>
              <input type="text" class="form-control" id="reg-name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">電話</label>
              <input type="tel" class="form-control" id="reg-phone" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="reg-email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" id="reg-note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-line" onclick="submitRegistration()">確認報名</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom JS -->
  <script>
    // 設定
const liffId = '2001679903-r5VXNe5g';  // 請替換為您的 LIFF ID
const gasUrl = 'https://script.google.com/macros/s/AKfycbwO01Tcvqf8HSyN3GB1v4mV4LpzrYqq3WyYlrmiL0VH7gvHx2nGg8HO0p4KgHGFmYO4/exec';   // 請替換為您的 GAS 部署網址

// 全域變數
let userData = null;
let isAdmin = false;
let activities = [];
let isLoading = false;

// 初始化 LIFF
async function initializeLiff() {
  try {
    await liff.init({ liffId });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    try {
      const profile = await liff.getProfile();
      userData = {
        userId: profile.userId,
        displayName: profile.displayName,
        pictureUrl: profile.pictureUrl
      };
      
      // 記錄使用者登入
      const loginResponse = await fetch(
        `${gasUrl}?action=userLogin&userId=${profile.userId}&displayName=${encodeURIComponent(profile.displayName)}&pictureUrl=${encodeURIComponent(profile.pictureUrl || '')}`
      );
      
      const loginResult = await loginResponse.json();
      
      if (loginResult.success) {
        updateUserInfo(profile);
        isAdmin = loginResult.isAdmin;
        
        if (isAdmin) {
          document.querySelectorAll('.admin-section').forEach(el => el.style.display = 'block');
        }
        
        // 載入活動列表
        await showActivities();
        
      } else {
        throw new Error(loginResult.message || '登入處理失敗');
      }
      
    } catch (error) {
      console.error('處理使用者資料時發生錯誤：', error);
      showError('載入使用者資料失敗');
    }
    
  } catch (error) {
    console.error('LIFF 初始化失敗：', error);
    showError('系統初始化失敗');
  }
}

// 更新使用者資訊顯示
function updateUserInfo(profile) {
  document.getElementById('user-info').innerHTML = `
    <div class="d-flex align-items-center">
      ${profile.pictureUrl ? 
        `<img src="${profile.pictureUrl}" alt="使用者頭像" class="me-2">` 
        : ''
      }
      <span>歡迎，${profile.displayName}</span>
    </div>
  `;
}

// 顯示活動列表
async function showActivities() {
  if (isLoading) return;
  
  const mainContent = document.getElementById('main-content');
  const loadingDiv = document.getElementById('loading');
  
  try {
    isLoading = true;
    loadingDiv.style.display = 'flex';
    
    const response = await fetch(`${gasUrl}?action=getActivities`);
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.message || '載入活動失敗');
    }
    
    activities = result.activities;
    
    mainContent.innerHTML = `
      <div class="row">
        <div class="col-12 mb-4">
          <h2>活動列表</h2>
          ${isAdmin ? `
            <button class="btn btn-line" onclick="showCreateActivityForm()">
              <i class="bi bi-plus-circle"></i> 新增活動
            </button>
          ` : ''}
        </div>
      </div>
      <div class="row" id="activities-container">
        ${activities.length > 0 ? renderActivities(activities) : `
          <div class="col-12">
            <div class="alert alert-info">
              目前沒有活動
            </div>
          </div>
        `}
      </div>
    `;
    
  } catch (error) {
    console.error('載入活動時發生錯誤：', error);
    showError(error.message || '載入失敗');
  } finally {
    isLoading = false;
    loadingDiv.style.display = 'none';
  }
}

// 渲染活動卡片
function renderActivities(activities) {
  return activities.map(activity => `
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card activity-card h-100">
        <div class="card-body">
          <h5 class="card-title">${escapeHtml(activity.title)}</h5>
          <div class="mb-3">
            <span class="status-badge ${getStatusClass(activity.status)}">
              ${activity.status}
            </span>
          </div>
          <p class="card-text">
            <small class="text-muted">
              <i class="bi bi-calendar"></i> ${activity.date}
            </small>
            <br>
            <small class="text-muted">
              <i class="bi bi-clock"></i> ${activity.startTime} - ${activity.endTime}
            </small>
            <br>
            <small class="text-muted">
              <i class="bi bi-geo-alt"></i> ${escapeHtml(activity.location)}
            </small>
          </p>
          <p class="card-text">
            ${escapeHtml(activity.description)}
          </p>
          <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" 
              style="width: ${(activity.currentParticipants / activity.maxParticipants * 100)}%"
              aria-valuenow="${activity.currentParticipants}"
              aria-valuemin="0"
              aria-valuemax="${activity.maxParticipants}">
              ${activity.currentParticipants}/${activity.maxParticipants}
            </div>
          </div>
        </div>
        <div class="card-footer bg-transparent">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              報名截止：${activity.deadline}
            </small>
            <button class="btn btn-sm btn-line" 
              onclick="showRegistrationForm('${activity.activityId}')"
              ${activity.status !== '報名中' ? 'disabled' : ''}>
              ${getStatusButton(activity.status)}
            </button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

// 顯示報名表單
function showRegistrationForm(activityId) {
  if (!userData) {
    alert('請先登入');
    return;
  }
  
  const activity = activities.find(a => a.activityId === activityId);
  if (!activity) {
    alert('找不到活動資訊');
    return;
  }
  
  document.getElementById('reg-activity-id').value = activityId;
  document.getElementById('reg-name').value = userData.displayName || '';
  
  const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
  modal.show();
}

// 提交報名
async function submitRegistration() {
  const form = document.getElementById('registration-form');
  const activityId = document.getElementById('reg-activity-id').value;
  
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  const registrationData = {
    activityId,
    userId: userData.userId,
    name: document.getElementById('reg-name').value,
    phone: document.getElementById('reg-phone').value,
    email: document.getElementById('reg-email').value,
    note: document.getElementById('reg-note').value
  };
  
  try {
    const response = await fetch(gasUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'register',
        data: registrationData
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('報名成功！');
      bootstrap.Modal.getInstance(document.getElementById('registrationModal')).hide();
      showActivities();
    } else {
      alert(result.message || '報名失敗，請稍後再試。');
    }
  } catch (error) {
    console.error('報名失敗：', error);
    alert('報名失敗，請稍後再試。');
  }
}

// 顯示錯誤訊息
function showError(message) {
  document.getElementById('main-content').innerHTML = `
    <div class="alert alert-danger">
      <h4 class="alert-heading">發生錯誤</h4>
      <p>${message}</p>
      <hr>
      <button class="btn btn-outline-danger" onclick="window.location.reload()">
        <i class="bi bi-arrow-clockwise"></i> 重新整理
      </button>
    </div>
  `;
}

// 取得狀態標籤樣式
function getStatusClass(status) {
  switch (status) {
    case '報名中': return 'registering';
    case '已額滿': return 'full';
    case '已截止': return 'closed';
    case '已結束': return 'ended';
    default: return '';
  }
}

// 取得狀態按鈕文字
function getStatusButton(status) {
  switch (status) {
    case '報名中':
      return '<i class="bi bi-person-plus"></i> 立即報名';
    case '已額滿':
      return '<i class="bi bi-x-circle"></i> 已額滿';
    case '已截止':
      return '<i class="bi bi-x-circle"></i> 已截止';
    case '已結束':
      return '<i class="bi bi-check-circle"></i> 已結束';
    default:
      return status;
  }
}

// HTML 轉義
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// 頁面載入完成後初始化
window.onload = initializeLiff;
  </script>
</body>
</html>
