<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>活動報名系統</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-8">
    <!-- 載入中提示 -->
    <div id="loading" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
    </div>
    
    <!-- 活動列表 -->
    <div id="eventList" class="hidden">
      <h1 class="text-2xl font-bold mb-6 text-center">活動列表</h1>
      <div id="eventCards" class="space-y-4"></div>
    </div>
    
    <!-- 報名表單 -->
    <div id="registrationForm" class="hidden">
      <button onclick="showEventList()" class="mb-4 text-blue-600">
        ← 返回活動列表
      </button>
      <div id="formContent"></div>
    </div>
  </div>

  <script>
    let currentEvent = null;
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwpdzC08EIVxKLrJF4QZmB3WFCb3xXAnhJoi59A4flxC5PNWpsy9yOPEIDvbNtxkxB2/exec';
    const LIFF_ID = '2001679903-r5VXNe5g';
    
    // 初始化LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          await loadEvents();
        }
      } catch (error) {
        showError('LIFF初始化失敗');
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }
    
    // 載入活動列表
    async function loadEvents() {
      try {
        const response = await fetch(`${GAS_URL}?action=getEvents`);
        const data = await response.json();
        
        if (data.status === 200) {
          displayEvents(data.data);
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        showError('載入活動失敗');
      }
    }
    
    // 顯示活動列表
    function displayEvents(events) {
      const container = document.getElementById('eventCards');
      container.innerHTML = events.map(event => `
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-2">${event.title}</h2>
          <p class="text-gray-600 mb-2">${event.datetime}</p>
          <p class="mb-4">${event.summary}</p>
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-500">
              報名人數：${event.currentParticipants}/${event.maxParticipants}
            </span>
            <button 
              onclick="showRegistrationForm('${event.id}')"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              ${!event.isRegistrationOpen ? 'disabled' : ''}>
              ${event.isRegistrationOpen ? '立即報名' : '報名截止'}
            </button>
          </div>
        </div>
      `).join('');
      
      document.getElementById('eventList').classList.remove('hidden');
    }
    
    // 顯示報名表單
    async function showRegistrationForm(eventId) {
      try {
        const response = await fetch(`${GAS_URL}?action=getEvent&eventId=${eventId}`);
        const data = await response.json();
        
        if (data.status === 200) {
          currentEvent = data.data;
          displayRegistrationForm(currentEvent);
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        showError('載入報名表單失敗');
      }
    }
    
    // 顯示報名表單
    function displayRegistrationForm(event) {
      document.getElementById('eventList').classList.add('hidden');
      const formContainer = document.getElementById('formContent');
      
      formContainer.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">${event.title}</h2>
        <p class="text-gray-600 mb-6">${event.datetime}</p>
        
        <form id="registrationForm" onsubmit="submitRegistration(event)">
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">參加人數</label>
            <select id="participantCount" 
                    onchange="updateParticipantFields()"
                    class="w-full border rounded px-3 py-2">
              ${[1,2,3,4,5].map(n => 
                `<option value="${n}">${n}人</option>`
              ).join('')}
            </select>
          </div>
          
          <div id="participantFields"></div>
          
          <button type="submit" 
                  class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
            提交報名
          </button>
        </form>
      `;
      
      document.getElementById('registrationForm').classList.remove('hidden');
      updateParticipantFields();
    }
    
    // 更新參加者欄位
    function updateParticipantFields() {
      const count = parseInt(document.getElementById('participantCount').value);
      const container = document.getElementById('participantFields');
      
      container.innerHTML = Array(count).fill(0).map((_, i) => `
        <div class="mb-6 p-4 border rounded">
          <h3 class="font-semibold mb-4">參加者 ${i + 1}</h3>
          
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">姓名 *</label>
            <input type="text" 
                   name="name_${i}" 
                   required
                   class="w-full border rounded px-3 py-2">
          </div>
          
          ${currentEvent.formType === 'standard_meal' ? `
            <div class="mb-4">
              <label class="block text-gray-700 mb-2">餐點選擇 *</label>
              <select name="meal_${i}" 
                      required
                      class="w-full border rounded px-3 py-2">
                <option value="葷食">葷食</option>
                <option value="素食">素食</option>
                <option value="不需要">不需要</option>
              </select>
            </div>
          ` : ''}
          
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">備註</label>
            <textarea name="note_${i}" 
                      class="w-full border rounded px-3 py-2"
                      rows="2"></textarea>
          </div>
        </div>
      `).join('');
    }
    
    // 提交報名
    async function submitRegistration(e) {
      e.preventDefault();
      
      try {
        const form = e.target;
        const count = parseInt(document.getElementById('participantCount').value);
        const participants = [];
        
        for (let i = 0; i < count; i++) {
          participants.push({
            name: form[`name_${i}`].value,
            meal: currentEvent.formType === 'standard_meal' ? 
                  form[`meal_${i}`].value : null,
            note: form[`note_${i}`].value
          });
        }
        
        const profile = await liff.getProfile();
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'submitRegistration',
            eventId: currentEvent.id,
            participants: participants,
            lineInfo: {
              userId: profile.userId,
              displayName: profile.displayName
            }
          })
        });
        
        const data = await response.json();
        
        if (data.status === 200) {
          alert('報名成功！');
          showEventList();
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        showError('報名失敗：' + error.message);
      }
    }
    
    // 顯示活動列表
    function showEventList() {
      document.getElementById('registrationForm').classList.add('hidden');
      document.getElementById('eventList').classList.remove('hidden');
      loadEvents();
    }
    
    // 顯示錯誤訊息
    function showError(message) {
      alert(message);
    }
    
    // 初始化
    document.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>
</html>
