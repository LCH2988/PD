<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>活動報名系統</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <!-- 載入中提示 -->
    <div id="loading" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
    </div>

    <!-- 活動列表 -->
    <div id="eventList" class="hidden">
      <h1 class="text-2xl font-bold mb-6 text-center">活動列表</h1>
      <div id="eventCards" class="space-y-4"></div>
    </div>

    <!-- 報名表單 -->
    <div id="registrationForm" class="hidden">
      <button onclick="showEventList()" class="mb-4 text-blue-600 hover:text-blue-800 flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        返回活動列表
      </button>
      <div id="formContent"></div>
    </div>

    <!-- 錯誤提示 -->
    <div id="errorToast" class="hidden fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg">
      <p id="errorMessage"></p>
    </div>
  </div>

  <script>
    let currentEvent = null;
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbze3550curwjFu7Ts2Gg5e7sBRZrsSIu5UBqD05C0yk6-3YTXQ8Xii8CksgXTsOBD0b/exec';
    const LIFF_ID = '2001679903-r5VXNe5g';
    
    // 初始化LIFF
   // 修改 initializeLiff 函數
async function initializeLiff() {
  try {
    console.log('Initializing LIFF...');
    await liff.init({ liffId: LIFF_ID });
    console.log('LIFF initialized');
    
    if (!liff.isLoggedIn()) {
      console.log('User not logged in, redirecting to login...');
      liff.login();
    } else {
      console.log('User logged in, loading events...');
      await loadEvents();
    }
  } catch (error) {
    console.error('LIFF initialization error:', error);
    showError(`LIFF初始化失敗: ${error.message}`);
  } finally {
    document.getElementById('loading').classList.add('hidden');
  }
}

    
    // 載入活動列表
   async function loadEvents() {
  try {
    const response = await fetch(`${GAS_URL}?action=getEvents`, {
      method: 'GET',
      mode: 'cors',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.status === 200) {
      displayEvents(data.data);
    } else {
      throw new Error(data.message || '載入活動失敗');
    }
  } catch (error) {
    console.error('Error:', error);
    showError(`載入活動失敗: ${error.message}`);
  }
}

    
    // 顯示活動列表
    function displayEvents(events) {
      const container = document.getElementById('eventCards');
      if (events.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">目前沒有開放報名的活動</p>';
      } else {
        container.innerHTML = events.map(event => `
          <div class="bg-white rounded-lg shadow p-6 hover:shadow-md transition-shadow">
            <h2 class="text-xl font-semibold mb-2">${event.title}</h2>
            <p class="text-gray-600 mb-2">
              <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              ${event.datetime}
            </p>
            <p class="text-gray-600 mb-2">
              <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              ${event.location}
            </p>
            <p class="mb-4">${event.summary}</p>
            <div class="flex justify-between items-center">
              <span class="text-sm ${event.currentParticipants >= event.maxParticipants ? 'text-red-500' : 'text-gray-500'}">
                報名人數：${event.currentParticipants}/${event.maxParticipants}
              </span>
              <button 
                onclick="showRegistrationForm('${event.id}')"
                class="${event.isRegistrationOpen ? 
                  'bg-blue-500 hover:bg-blue-600' : 
                  'bg-gray-400 cursor-not-allowed'} 
                  text-white px-4 py-2 rounded transition-colors"
                ${!event.isRegistrationOpen ? 'disabled' : ''}>
                ${event.isRegistrationOpen ? '立即報名' : '報名截止'}
              </button>
            </div>
          </div>
        `).join('');
      }
      
      document.getElementById('eventList').classList.remove('hidden');
    }
    
    // 顯示報名表單
    async function showRegistrationForm(eventId) {
      try {
        const response = await fetch(`${GAS_URL}?action=getEvent&eventId=${eventId}`);
        const data = await response.json();
        
        if (data.status === 200) {
          currentEvent = data.data;
          displayRegistrationForm(currentEvent);
        } else {
          throw new Error(data.message || '載入報名表單失敗');
        }
      } catch (error) {
        showError(error.message);
      }
    }
    
    // 顯示報名表單
    function displayRegistrationForm(event) {
      document.getElementById('eventList').classList.add('hidden');
      const formContainer = document.getElementById('formContent');
      
      formContainer.innerHTML = `
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-2">${event.title}</h2>
          <p class="text-gray-600 mb-4">${event.datetime}</p>
          <p class="mb-6">${event.content || event.summary}</p>
          
          <form id="registrationForm" onsubmit="submitRegistration(event)" class="space-y-6">
            <div class="mb-4">
              <label class="block text-gray-700 mb-2">參加人數</label>
              <select id="participantCount" 
                      onchange="updateParticipantFields()"
                      class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                ${[1,2,3,4,5].map(n => 
                  `<option value="${n}">${n}人</option>`
                ).join('')}
              </select>
            </div>
            
            <div id="participantFields" class="space-y-6"></div>
            
            <button type="submit" 
                    class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 
                           transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
              確認報名
            </button>
          </form>
        </div>
      `;
      
      document.getElementById('registrationForm').classList.remove('hidden');
      updateParticipantFields();
    }
    
    // 更新參加者欄位
    function updateParticipantFields() {
      const count = parseInt(document.getElementById('participantCount').value);
      const container = document.getElementById('participantFields');
      
      container.innerHTML = Array(count).fill(0).map((_, i) => `
        <div class="p-4 border rounded-lg">
          <h3 class="font-semibold mb-4">參加者 ${i + 1}</h3>
          
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">姓名 *</label>
            <input type="text" 
                   name="name_${i}" 
                   required
                   class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="請輸入姓名">
          </div>
          
          ${currentEvent.formType === 'standard_meal' ? `
            <div class="mb-4">
              <label class="block text-gray-700 mb-2">餐點選擇 *</label>
              <select name="meal_${i}" 
                      required
                      class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">請選擇</option>
                <option value="葷食">葷食</option>
                <option value="素食">素食</option>
                <option value="不需要">不需要餐點</option>
              </select>
            </div>
          ` : ''}
          
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">備註</label>
            <textarea name="note_${i}" 
                      class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      rows="2"
                      placeholder="如有特殊需求請註明"></textarea>
          </div>
        </div>
      `).join('');
    }
    
    // 提交報名
    // 修改 submitRegistration 函數
async function submitRegistration(e) {
  e.preventDefault();
  
  try {
    const form = e.target;
    const count = parseInt(document.getElementById('participantCount').value);
    const participants = [];
    
    for (let i = 0; i < count; i++) {
      participants.push({
        name: form[`name_${i}`].value.trim(),
        meal: currentEvent.formType === 'standard_meal' ? 
              form[`meal_${i}`].value : null,
        note: form[`note_${i}`].value.trim()
      });
    }
    
    const profile = await liff.getProfile();
    const response = await fetch(GAS_URL, {
      method: 'POST',
      mode: 'cors',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'submitRegistration',
        eventId: currentEvent.id,
        participants: participants,
        lineInfo: {
          userId: profile.userId,
          displayName: profile.displayName
        }
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.status === 200) {
      alert('報名成功！');
      showEventList();
    } else {
      throw new Error(data.message || '報名失敗');
    }
  } catch (error) {
    console.error('Error:', error);
    showError(`報名失敗: ${error.message}`);
  }
}
    
    // 顯示活動列表
    function showEventList() {
      document.getElementById('registrationForm').classList.add('hidden');
      document.getElementById('eventList').classList.remove('hidden');
      loadEvents();
    }
    
   // 在前端增加錯誤處理函數
function showError(message) {
  console.error('Error:', message);
  const toast = document.getElementById('errorToast');
  const messageElement = document.getElementById('errorMessage');
  messageElement.textContent = message;
  toast.classList.remove('hidden');
  setTimeout(() => {
    toast.classList.add('hidden');
  }, 5000);
}

// 在後端增加日誌記錄
function logError(error, context = '') {
  console.error(`Error ${context}:`, error);
  // 可以加入將錯誤記錄到試算表的功能
}

    
    // 初始化
    document.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>

</html>
