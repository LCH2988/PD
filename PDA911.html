<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
  <style>
    .loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.form-label.required::after {
    content: " *";
    color: red;
}

.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    margin-right: 15px;
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.radio-item {
    display: flex;
    align-items: center;
}

.form-text {
    font-size: 0.875em;
    color: #6c757d;
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
}
</style>

    
<body>
    <!-- 載入中畫面 -->
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 主要內容 -->
    <div class="container my-4">
        <h1 id="eventTitle" class="text-center mb-4">活動報名系統</h1>
        <div id="eventDescription" class="alert alert-info mb-4"></div>

        <!-- 錯誤訊息 -->
        <div id="error-message" class="alert alert-danger" style="display: none;"></div>

        <!-- 報名表單 -->
        <form id="registrationForm" class="needs-validation" novalidate>
            <!-- LINE 資訊 -->
            <div class="mb-3">
                <label for="displayName" class="form-label">LINE 名稱</label>
                <input type="text" class="form-control" id="displayName" name="displayName" readonly>
                <input type="hidden" id="userId" name="userId">
            </div>

            <!-- 動態生成的表單欄位會插入這裡 -->
            <div id="formFields"></div>

            <!-- 送出按鈕 -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary" id="confirmOrderBtn">確認報名</button>
            </div>
        </form>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">報名結果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalMessage"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const CONFIG = {
    // Google Apps Script 部署網址
    SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyIMBoLnhjiznAO1NvkGB7ML0QIUmYPyn2ZAEmr0SeErbT0qsZd9k4uVBVskPZ-v1yt/exec',
    // LIFF ID
    LIFF_ID: '2001679903-r5VXNe5g'
    };

      // 全域變數
let registrationData = [];

// LIFF 初始化
async function initializeLiff() {
    try {
        await liff.init({ 
            liffId: CONFIG.LIFF_ID,
            withLoginOnExternalBrowser: true
        });
        
        console.log("LIFF initialization successful");

        if (!liff.isLoggedIn()) {
            await liff.login();
        } else {
            // 獲取用戶資料
            const profile = await liff.getProfile();
            document.getElementById('displayName').value = profile.displayName;
            document.getElementById('userId').value = profile.userId;
            initializeApp();
        }
    } catch (error) {
        console.error("LIFF initialization failed:", error);
        showError(`LIFF 初始化失敗: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// 初始化應用程式
async function initializeApp() {
    try {
        // 取得表單設定
        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getFormConfig`);
        const data = await response.json();
        
        // 設定活動資訊
        document.getElementById('eventTitle').textContent = data.content.活動標題;
        document.getElementById('eventDescription').textContent = data.content.活動簡介;

        // 生成表單欄位
        generateFormFields(data.config);

        // 設定表單提交事件
        document.getElementById('registrationForm').addEventListener('submit', handleSubmit);

    } catch (error) {
        console.error('初始化失敗:', error);
        showError('初始化失敗: ' + error.message);
    }
}

// 生成表單欄位
function generateFormFields(config) {
    const formFields = document.getElementById('formFields');
    
    config.forEach(field => {
        const fieldContainer = document.createElement('div');
        fieldContainer.className = 'mb-3';

        const label = document.createElement('label');
        label.className = `form-label${field.required ? ' required' : ''}`;
        label.textContent = field.label;

        let input;

        switch (field.type) {
            case 'textarea':
                input = document.createElement('textarea');
                input.className = 'form-control';
                break;

            case 'radio':
            case 'checkbox':
                input = document.createElement('div');
                input.className = `${field.type}-group`;
                if (field.required) input.dataset.required = 'true';
                
                field.options.forEach(option => {
                    const wrapper = document.createElement('div');
                    wrapper.className = `form-check${field.type === 'radio' ? ' form-check-inline' : ''}`;
                    
                    const optionInput = document.createElement('input');
                    optionInput.className = 'form-check-input';
                    optionInput.type = field.type;
                    optionInput.name = field.id;
                    optionInput.value = option;
                    optionInput.id = `${field.id}_${option}`;
                    
                    const optionLabel = document.createElement('label');
                    optionLabel.className = 'form-check-label';
                    optionLabel.htmlFor = `${field.id}_${option}`;
                    optionLabel.textContent = option;
                    
                    wrapper.appendChild(optionInput);
                    wrapper.appendChild(optionLabel);
                    input.appendChild(wrapper);
                });
                break;

            default:
                input = document.createElement('input');
                input.className = 'form-control';
                input.type = field.type;
        }

        if (field.type !== 'radio' && field.type !== 'checkbox') {
            input.name = field.id;
            input.required = field.required;
        }

        fieldContainer.appendChild(label);
        fieldContainer.appendChild(input);
        formFields.appendChild(fieldContainer);
    });
}

// 表單提交處理
async function handleSubmit(e) {
    e.preventDefault();

    // 檢查必填欄位
    const form = e.target;
    if (!form.checkValidity()) {
        e.stopPropagation();
        form.classList.add('was-validated');
        return;
    }

    // 檢查必填的勾選式欄位
    const requiredCheckboxGroups = form.querySelectorAll('.checkbox-group[data-required="true"]');
    for (let group of requiredCheckboxGroups) {
        if (!group.querySelector('input:checked')) {
            alert('請至少選擇一個選項');
            return;
        }
    }

    // 禁用提交按鈕
    const confirmOrderBtn = document.getElementById('confirmOrderBtn');
    confirmOrderBtn.disabled = true;
    confirmOrderBtn.textContent = '登記中...';

    try {
        // 準備表單資料
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // 發送資料到後端
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'addRegistration',
                data: data
            })
        });

        const result = await response.json();

        // 顯示結果
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        document.getElementById('modalMessage').textContent = result.message;
        modal.show();

        // 如果成功，重置表單
        if (result.success) {
            form.reset();
            // 重新設定 LINE 名稱
            document.getElementById('displayName').value = liff.getProfile().displayName;
        }

    } catch (error) {
        console.error('提交失敗:', error);
        showError('提交失敗: ' + error.message);
    } finally {
        // 重新啟用提交按鈕
        confirmOrderBtn.disabled = false;
        confirmOrderBtn.textContent = '確認報名';
    }
}

// 顯示錯誤訊息
function showError(message) {
    const errorElement = document.getElementById('error-message');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

// 隱藏載入畫面
function hideLoading() {
    document.querySelector('.loading').style.display = 'none';
}

// 初始化
window.onload = initializeLiff;

    </script>
</body>
</html>
